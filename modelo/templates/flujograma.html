<style>
    .materia {
        color: #aeaeae;
        font-size: 12px;
        font-weight: 400;
        height: 100px;
        overflow-wrap: break-word
    }

    .materia_head {
        height: 20px !important;
    }

    td {
        vertical-align: middle !important;
    }

    .materia_vista {
        background-color: green;
        color: white;
    }

    .materia_no_existe {
        background-color: red;
        color: white;
    }

    .materia_porver:hover {
        color: black;
        background-color: white;
        -moz-transition: all 0.3s cubic-bezier(0.8, 0.2, 0.2, 0.9);
        -o-transition: all 0.3s cubic-bezier(0.8, 0.2, 0.2, 0.9);
        -webkit-transition: all 0.3s cubic-bezier(0.8, 0.2, 0.2, 0.9);
        transition: all 0.3s cubic-bezier(0.8, 0.2, 0.2, 0.9);
        cursor: pointer;
    }

    .trantition_materia_selected {
        transform: scale(1.5, 1.5);
        -moz-transition: all 0.2s cubic-bezier(0.8, 0.2, 0.2, 0.9);
        -o-transition: all 0.2s cubic-bezier(0.8, 0.2, 0.2, 0.9);
        -webkit-transition: all 0.2s cubic-bezier(0.8, 0.2, 0.2, 0.9);
        transition: all 0.2s cubic-bezier(0.8, 0.2, 0.2, 0.9);
    }

    .materia_selected {
        color: black;
        background-color: white;
        cursor: pointer;
    }

    #number_materias {
        font-size: 14px;
        color: white;
        width: 200px;
        -moz-transition: all 0.2s cubic-bezier(0.8, 0.2, 0.2, 0.9);
        -o-transition: all 0.2s cubic-bezier(0.8, 0.2, 0.2, 0.9);
        -webkit-transition: all 0.2s cubic-bezier(0.8, 0.2, 0.2, 0.9);
        transition: all 0.2s cubic-bezier(0.8, 0.2, 0.2, 0.9);
    }

</style>
<div class="table-responsive">

    {% csrf_token %}
    <h5 style="color: white; text-align: left">UNIVERSIDAD METROPOLITANA</h5>
    <h5 style="color: white; text-align: left">FLUJOGRAMA DE {{ carrera }}</h5>
    <h6 style="color: white">Períodos Académicos</h6>
    <table class="table table-bordered" style="table-layout: fixed;">
        <thead>
        <tr class="materia materia_head">
            <th scope="col">I</th>
            <th scope="col">II</th>
            <th scope="col">III</th>
            <th scope="col">IV</th>
            <th scope="col">V</th>
            <th scope="col">VI</th>
            <th scope="col">VII</th>
            <th scope="col">VIII</th>
            <th scope="col">IX</th>
            <th scope="col">X</th>
            <th scope="col">XI</th>
            <th scope="col">XII</th>
        </tr>
        </thead>
        <tbody>
        <tr id="row1" class="materia"></tr>
        <tr id="row2" class="materia"></tr>
        <tr id="row3" class="materia"></tr>
        <tr id="row4" class="materia"></tr>
        <tr id="row5" class="materia"></tr>
        </tbody>
    </table>
</div>

<div class="container-fluid">

</div>

<div class="container-fluid d-flex justify-content-end" style="align-items: baseline; padding-right: 0;">
    <p id="number_materias" style="flex: 1 0 auto; position: absolute; left: 43.5%; bottom: 2%;">
        0/7 materias seleccionadas
    </p>
    <a id="predict" class="btn-get-started" style="margin-right: 0; margin-top: 0; padding: 10px 15px;">
        Realizar Predicción
    </a>
</div>
<script>


    var materias_selected = [];

    $(document).ready(function () {

        {% autoescape off %}
            var flujograma = {{ flujograma }};
        {% endautoescape %}

        var aux = 0;
        var materias = 0;
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        flujograma = Object.entries(flujograma)

        while (aux != 5) {
            for (var i = aux; i < 60; i += 5) {
                var row = aux + 1

                if (flujograma[i][1][1] == undefined) {
                    $('#row' + row).append('<td class="materia_no_existe"> - </td>')
                } else {

                    if (flujograma[i][1][0] == 1) {
                        $('#row' + row).append('<td class="materia_vista">' + flujograma[i][1][1] + '</td>')
                    } else {
                        $('#row' + row).append('<td id="' + flujograma[i][0] + '" class="materia_porver">' + flujograma[i][1][1] + '</td>')
                    }
                }
            }
            aux++
        }

        $('.materia_porver').on('click', function () {
            if ($(this).hasClass('materia_selected')) {
                if (materias > 0) {

                    var index_mat = materias_selected.indexOf($(this).attr('id'));
                    materias_selected.splice(index_mat, 1);

                    $('#number_materias').addClass('trantition_materia_selected');
                    setTimeout(function () {
                        $('#number_materias').removeClass('trantition_materia_selected');
                    }, 400);
                    $('#' + $(this).attr('id')).removeClass('materia_selected');

                    materias--;
                    $('#number_materias').text(materias + '/7 materias seleccionadas')
                }
            } else {
                if (materias < 7) {

                    materias_selected.push($(this).attr('id'));

                    $('#number_materias').addClass('trantition_materia_selected');
                    setTimeout(function () {
                        $('#number_materias').removeClass('trantition_materia_selected');
                    }, 400);
                    $('#' + $(this).attr('id')).addClass('materia_selected');
                    materias++;
                    $('#number_materias').text(materias + '/7 materias seleccionadas');
                } else {
                    swal.fire('Estimado estudiante:', 'Ya ha seleccionado el numero maximo de materias.', 'error');
                }
            }

        });

        $.ajaxSetup({
            'headers': {
                'X-CSRFToken': csrftoken,
            }
        });

    });

    $('#predict').on('click', function () {

        if (materias_selected.length == 0) {
            swal.fire('', 'No se han seleccionado materias a predecir', 'error');
            return
        }


        swal.fire({
            text: '¿Desea realizar la predicción con las materias seleccionadas?',
            confirmButtonText: 'Predecir',
            showCancelButton: true,
            cancelButtonText: 'Volver',
            icon: 'warning'
        }).then(function (data) {
            if (data.isConfirmed) {
                loading();
                $("#body-content").load('predict/' + {{ ci }}, {
                    'materias': materias_selected
                }, function () {
                    loading(false);
                });
            }

        });
    });


</script>
